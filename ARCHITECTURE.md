# Архитектура системы Timezone

## Структура данных

```
┌─────────────────────────────────────────────────────────┐
│                   БАЗА ДАННЫХ                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────┐    ┌─────────────────────┐   │
│  │  tasks              │    │  user_settings      │   │
│  │  ─────────────────  │    │  ─────────────────  │   │
│  │  • id               │    │  • id               │   │
│  │  • chat_id          │    │  • user_id (unique) │   │
│  │  • user_id          │    │  • chat_id          │   │
│  │  • text             │    │  • timezone    ⭐   │   │
│  │  • status           │    │  • created_at       │   │
│  │  • parent_id        │    │  • updated_at       │   │
│  │  • created_at       │    │                     │   │
│  │  • updated_at       │    └─────────────────────┘   │
│  └─────────────────────┘                               │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  schedules                                       │  │
│  │  ────────────────────────────────────────────   │  │
│  │  • id                                            │  │
│  │  • chat_id                                       │  │
│  │  • user_id                                       │  │
│  │  • text                                          │  │
│  │  • day_of_week                                   │  │
│  │  • time                                          │  │
│  │  • timezone: CharField(default="UTC")      ⭐   │  │
│  │  • enabled                                       │  │
│  │  • created_at                                    │  │
│  │  • updated_at                                    │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Поток обработки команды

```
┌─────────────────────┐
│ Пользователь вводит │
│  /timezone москва   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────────┐
│   Обработчик set_timezone()     │
│  (core/handlers.py)             │
├─────────────────────────────────┤
│ 1. Парсит аргумент: "москва"   │
│ 2. Валидирует зону              │
└──────────┬──────────────────────┘
           │
      ┌────▼────┐
      │ Валидна?│
      └────┬────┘
           │
   ┌───────┼───────┐
   │ ДА    │       │ НЕТ
   ▼       │       ▼
┌──────┐   │    ┌─────────────┐
│valid │   │    │find_timezone│
│_tz   │   │    │_by_keyword  │
└──┬───┘   │    │("москва")   │
   │       │    │  ↓          │
   │       │    │ Найдена!    │
   └───────┼─────────────┬────┘
           │ ✅ valid_tz = "Europe/Moscow"
           ▼
┌──────────────────────────────┐
│ Сохранить в UserSettings     │
│ - user_id → timezone         │
├──────────────────────────────┤
│ INSERT/UPDATE user_settings  │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ Обновить все расписания      │
│ пользователя                 │
├──────────────────────────────┤
│ UPDATE schedules             │
│ SET timezone = valid_tz      │
│ WHERE user_id = ?            │
└──────────┬───────────────────┘
           │
           ▼
┌────────────────────────────────┐
│ Отправить подтверждение       │
│ ✅ Timezone установлена:      │
│    Europe/Moscow              │
└────────────────────────────────┘
```

## Интеграция со Scheduler

```
┌─────────────────────────────────────────────────────────┐
│            SCHEDULER (send_reminders)                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 1. Получить текущее UTC время                          │
│    now_utc = datetime.now(pytz.UTC)                    │
│                                                         │
│ 2. Для каждого расписания:                             │
│    ┌──────────────────────────────────────────┐        │
│    │ user_tz = pytz.timezone(sched.timezone) │        │
│    │ local_time = now_utc.astimezone(        │        │
│    │   user_tz).time()                        │        │
│    │ sched_time = parse(sched.time)           │        │
│    └──────────────────────────────────────────┘        │
│                                                         │
│ 3. Если время совпадает (±1 минута):                   │
│    send_message(chat_id, reminder_text)                │
│                                                         │
└─────────────────────────────────────────────────────────┘

Пример:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
UTC время:     12:00
Timezone:      Europe/Moscow (UTC+3)
Локальное:     15:00

Расписание:    день=понедельник, время=15:00
               timezone=Europe/Moscow

Результат: ✅ ОТПРАВИТЬ НАПОМИНАНИЕ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## Функции утилит

```
core/utils.py
═════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────┐
│ get_valid_timezones()                               │
│ → Returns: List[str] (597 zones)                    │
├─────────────────────────────────────────────────────┤
│ Используется для получения всех доступных зон      │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ is_valid_timezone(tz_name: str)                     │
│ → Returns: bool                                      │
├─────────────────────────────────────────────────────┤
│ Проверяет валидность введённой пользователем зоны  │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ find_timezone_by_keyword(keyword: str)              │
│ → Returns: Optional[str]                            │
├─────────────────────────────────────────────────────┤
│ 1. Ищет в словаре популярных зон (русские имена)  │
│ 2. Ищет в полном списке всех зон                   │
│ 3. Возвращает первый найденный результат           │
│                                                     │
│ Примеры:                                            │
│  "москва" → "Europe/Moscow"                         │
│  "Tokyo" → "Asia/Tokyo"                             │
│  "NY" → "America/New_York"                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ get_timezone_offset(tz_name: str)                   │
│ → Returns: Optional[str]                            │
├─────────────────────────────────────────────────────┤
│ "Europe/Moscow" → "UTC+03:00"                       │
│ "America/New_York" → "UTC-05:00"                    │
│ "Asia/Tokyo" → "UTC+09:00"                          │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│ format_timezone_list()                              │
│ → Returns: str                                       │
├─────────────────────────────────────────────────────┤
│ Europe/Moscow (Москва, +03:00)                      │
│ Europe/Kyiv (Киев, +02:00/+03:00)                   │
│ Europe/London (Лондон, GMT/BST)                     │
│ ... и ещё 7 популярных зон ...                      │
└─────────────────────────────────────────────────────┘
```

## Словарь популярных зон (find_timezone_by_keyword)

```
РУССКИЙ              АНГЛИЙСКИЙ              TIMEZONE
─────────────────────────────────────────────────────────
москва               moscow                  Europe/Moscow
мск                  msk                     Europe/Moscow
санкт-петербург      saint-petersburg        Europe/Moscow
питер                peter                   Europe/Moscow
киев                 kyiv                    Europe/Kyiv
украина              ukraine                 Europe/Kyiv
нью-йорк             new-york                America/New_York
сша                  usa                     America/New_York
лондон               london                  Europe/London
англия               england                 Europe/London
берлин               berlin                  Europe/Berlin
германия             germany                 Europe/Berlin
париж                paris                   Europe/Paris
франция              france                  Europe/Paris
токио                tokyo                   Asia/Tokyo
япония               japan                   Asia/Tokyo
пекин                beijing                 Asia/Shanghai
китай                china                   Asia/Shanghai
индия                india                   Asia/Kolkata
дубай                dubai                   Asia/Dubai
сингапур             singapore               Asia/Singapore
сидней               sydney                  Australia/Sydney
австралия            australia               Australia/Sydney
бангкок              bangkok                 Asia/Bangkok
таиланд              thailand                Asia/Bangkok
```

## Примеры команд

```
ПОЛЬЗОВАТЕЛЬ                    БОТ ОТВЕТИТ
──────────────────────────────────────────────────────────
/timezone Москва        →  ✅ Временная зона установлена: 
                            Europe/Moscow

/timezone Europe/Moscow →  ✅ Временная зона установлена: 
                            Europe/Moscow

/timezone нью-йорк      →  ✅ Временная зона установлена: 
                            America/New_York

/timezone                →  ⏰ Ваша текущая временная зона: 
                            Europe/Moscow
                            
                            Использование: /timezone <зона>
                            
                            Примеры:
                            Europe/Moscow (Москва, +03:00)
                            ... (показать 10 популярных)

/timezone invalid       →  ❌ Временная зона 'invalid' не 
                            найдена.
                            
                            Популярные зоны:
                            ... (показать 10 популярных)
```

## Жизненный цикл напоминания

```
1. СОЗДАНИЕ РАСПИСАНИЯ
   /schedule_add понедельник 09:00 Зарядка
   
   ├─ Проверить user_id
   ├─ Получить timezone из UserSettings (или UTC)
   └─ Создать Schedule с timezone
      
2. ХРАНЕНИЕ
   Schedule(
     user_id="123",
     time="09:00",
     timezone="Europe/Moscow",  ← Сохранена!
     day_of_week=0
   )

3. ПРОВЕРКА (каждую минуту)
   Scheduler.send_reminders():
   ├─ now_utc = 07:00 UTC (12:00 Moscow)
   ├─ user_tz = pytz.timezone("Europe/Moscow")
   ├─ local_time = now_utc.astimezone(user_tz) = 10:00
   ├─ sched_time = 09:00
   └─ |10:00 - 09:00| = 1 час > 1 минута → НЕ ОТПРАВЛЯТЬ

   (спустя 60 минут)
   ├─ now_utc = 08:00 UTC (11:00 Moscow... ошибка!)
   
   ИСПРАВЛЕНИЕ:
   ├─ now_utc = 06:00 UTC (09:00 Moscow) ✅
   ├─ local_time = 09:00
   └─ |09:00 - 09:00| = 0 → ОТПРАВИТЬ!

4. ОТПРАВКА
   await bot.send_message(
     chat_id="chat_123",
     text="Напоминание: Зарядка\nВремя: 09:00 (Europe/Moscow)"
   )

5. ГОТОВО ✅
```
